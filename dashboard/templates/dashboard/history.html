{% extends 'dashboard/base.html' %}

{% block title %}Query - SmartSQL Insight{% endblock %}

{% block styles %}
<style>
    .schema-info {
        max-height: 300px;
        overflow-y: auto;
    }
    .result-table {
        overflow-x: auto;
    }
    .loading-spinner {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-md-3">
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Database Schema</h5>
                </div>
                <div class="card-body schema-info">
                    {% for table in schema_info %}
                    <div class="mb-3">
                        <h6 class="fw-bold">{{ table.table }}</h6>
                        <ul class="list-unstyled ms-3 small">
                            {% for column in table.columns %}
                            <li><code>{{ column.name }}</code> <span class="text-muted">({{ column.type }})</span></li>
                            {% endfor %}
                        </ul>
                        {% if table.foreign_keys %}
                        <p class="mb-1 fw-bold small">Foreign Keys:</p>
                        <ul class="list-unstyled ms-3 small">
                            {% for fk in table.foreign_keys %}
                            <li><code>{{ fk.column }}</code> â†’ <code>{{ fk.references_table }}({{ fk.references_column }})</code></li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="col-md-9">
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Natural Language Query</h5>
                </div>
                <div class="card-body">
                    <form id="queryForm" method="post" action="{% url 'dashboard:process_query' %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            {{ form.query }}
                        </div>
                        <div class="d-flex align-items-center">
                            <button type="submit" class="btn btn-primary">Generate SQL & Execute</button>
                            <div class="loading-spinner ms-3">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <span class="ms-2">Processing query...</span>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <div id="resultSection" class="d-none">
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Generated SQL</h5>
                    </div>
                    <div class="card-body">
                        <pre id="sqlQuery" class="bg-light p-3 rounded"></pre>
                    </div>
                </div>
                
                <div class="card shadow-sm mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Query Results</h5>
                        <div class="btn-group">
                            <button id="exportCSV" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-file-earmark-spreadsheet"></i> Export CSV
                            </button>
                        </div>
                    </div>
                    <div class="card-body result-table">
                        <div id="queryResults"></div>
                    </div>
                </div>
                
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Feedback</h5>
                    </div>
                    <div class="card-body">
                        <form id="feedbackForm">
                            {% csrf_token %}
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="isHelpful" name="is_helpful">
                                    <label class="form-check-label" for="isHelpful">Was this query helpful?</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Rate this query (1-5):</label>
                                <div class="btn-group" role="group">
                                    <input type="radio" class="btn-check" name="rating" id="rating1" value="1" autocomplete="off">
                                    <label class="btn btn-outline-secondary" for="rating1">1</label>
                                    
                                    <input type="radio" class="btn-check" name="rating" id="rating2" value="2" autocomplete="off">
                                    <label class="btn btn-outline-secondary" for="rating2">2</label>
                                    
                                    <input type="radio" class="btn-check" name="rating" id="rating3" value="3" autocomplete="off">
                                    <label class="btn btn-outline-secondary" for="rating3">3</label>
                                    
                                    <input type="radio" class="btn-check" name="rating" id="rating4" value="4" autocomplete="off">
                                    <label class="btn btn-outline-secondary" for="rating4">4</label>
                                    
                                    <input type="radio" class="btn-check" name="rating" id="rating5" value="5" autocomplete="off">
                                    <label class="btn btn-outline-secondary" for="rating5">5</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="comments" class="form-label">Comments:</label>
                                <textarea class="form-control" id="comments" name="comments" rows="2"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Submit Feedback</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentQueryId = null;
    
    // Process Query Form Submission
    document.getElementById('queryForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Show loading spinner
        document.querySelector('.loading-spinner').style.display = 'flex';
        
        // Hide any previous results
        document.getElementById('resultSection').classList.add('d-none');
        
        // Get form data
        const formData = new FormData(this);
        
        // Send AJAX request
        fetch("{% url 'dashboard:process_query' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            // Hide loading spinner
            document.querySelector('.loading-spinner').style.display = 'none';
            
            if (data.success) {
                // Store the query ID
                currentQueryId = data.query_id;
                
                // Display SQL query
                document.getElementById('sqlQuery').textContent = data.sql;
                
                // Display results
                displayResults(data.result);
                
                // Show result section
                document.getElementById('resultSection').classList.remove('d-none');
                
                // Set up export button
                document.getElementById('exportCSV').onclick = function() {
                    window.location.href = `/dashboard/export-csv/${currentQueryId}/`;
                };
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.querySelector('.loading-spinner').style.display = 'none';
            alert('An error occurred while processing your query.');
        });
    });
    
    // Display Query Results
    function displayResults(result) {
        const resultsDiv = document.getElementById('queryResults');
        
        if (result.success) {
            if (result.data.length === 0) {
                resultsDiv.innerHTML = '<div class="alert alert-info">Query executed successfully but returned no results.</div>';
                return;
            }
            
            // Create table
            let tableHTML = '<table class="table table-striped table-hover">';
            
            // Table header
            tableHTML += '<thead><tr>';
            result.columns.forEach(column => {
                tableHTML += `<th>${column}</th>`;
            });
            tableHTML += '</tr></thead>';
            
            // Table body
            tableHTML += '<tbody>';
            result.data.forEach(row => {
                tableHTML += '<tr>';
                result.columns.forEach(column => {
                    tableHTML += `<td>${row[column] !== null ? row[column] : 'NULL'}</td>`;
                });
                tableHTML += '</tr>';
            });
            tableHTML += '</tbody></table>';
            
            resultsDiv.innerHTML = tableHTML;
        } else {
            resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${result.error}</div>`;
        }
    }
    
    // Feedback Form Submission
    document.getElementById('feedbackForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!currentQueryId) {
            alert('No query to provide feedback for.');
            return;
        }
        
        // Check if rating is selected
        const ratingSelected = document.querySelector('input[name="rating"]:checked');
        if (!ratingSelected) {
            alert('Please select a rating (1-5).');
            return;
        }
        
        // Get form data
        const formData = new FormData(this);
        
        // Send AJAX request
        fetch(`/dashboard/feedback/${currentQueryId}/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Thank you for your feedback!');
                // Reset form
                document.getElementById('isHelpful').checked = false;
                document.querySelector('input[name="rating"]:checked').checked = false;
                document.getElementById('comments').value = '';
            } else {
                alert('Error saving feedback: ' + JSON.stringify(data.errors));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while submitting your feedback.');
        });
    });
</script>
{% endblock %}